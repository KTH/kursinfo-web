"use strict";var KthToolbarConfig,msglang={'remfav':{'sv':"Ta bort favorit",'en':"Remove favorite"},'noremfav':{'sv':"Kunde inte ta bort favorit",'en':"Failed to remove favorite"},'addfav':{'sv':"Lägg till favorit",'en':"Add favorite"},'noaddfav':{'sv':"Kunde inte lägga till favorit",'en':"Failed to add favorite"},'mainfail':{'sv':'Kunde inte hämta personlig information (klicka för att försöka igen)','en':'Failed to load your information (click to retry)'},'err':{'sv':"Hoppsan!",'en':"Oops!"},'fetchfailed':{'sv':"Ursäkta, vi kunde tyvärr inte hämta din information. Försök gärna igen.",'en':"Sorry, we could not get your information. Please try again.",},'nofav':{'sv':'Du har inte lagt till några favoriter än. Klicka på "Alla" ovan och välj dina favoriter genom att klicka på stjärnan.','en':'You do not have any favorites yet. Click on "All" above and choose your faviorites by clicking on the star.'},};if(KthToolbarConfig===undefined){KthToolbarConfig={};}
KthToolbarConfig.frontUrl=KthToolbarConfig.frontUrl||"https://www.kth.se";KthToolbarConfig.socialUrl=KthToolbarConfig.socialUrl||"https://www.kth.se/social";KthToolbarConfig.loginMethod=KthToolbarConfig.loginMethod||'POST';KthToolbarConfig.locale=KthToolbarConfig.locale||"sv_SE";KthToolbarConfig.language=KthToolbarConfig.locale.split('_')[0];KthToolbarConfig.enableSystemAlert=KthToolbarConfig.enableSystemAlert||"True";if(!KthToolbarConfig.loginUrl){KthToolbarConfig.loginUrl="https://www.kth.se/social/accounts/login/?next="+escape(location.href);}else{if(KthToolbarConfig.loginUrl.charAt(0)==='?'){KthToolbarConfig.loginUrl="https://www.kth.se/social/accounts/login/?next="+escape(location.href+KthToolbarConfig.loginUrl);}else{KthToolbarConfig.loginUrl="https://www.kth.se/social/accounts/login/?next="+escape(KthToolbarConfig.loginUrl);}}
function initKthToolbar(){function log(text){return true;}
function msg(ref){let m=msglang[ref];return m[KthToolbarConfig.language]||m['en'];}
function hidemenuPanel(){var pm=document.getElementById('kth-pmenu'),mp=pm.querySelector('#menu-panel'),mpi=mp.querySelector('.menu-panel-inner');pm.classList.remove('kpmopen');mp.classList.add('hide');if(mpi){mpi.innerHTML='';}
[].forEach.call(pm.querySelectorAll('.kpmbar .current'),function(elem){elem.classList.remove('current')});}
function showmenuPanel(){var mp=document.getElementById('menu-panel'),mpi=mp.querySelector('.menu-panel-inner');mp.classList.remove('hide');mpi.querySelector('a').focus();mp.addEventListener('keydown',function(e){if(e.keyCode===27){ hidemenuPanel();var curr=document.querySelector('#kth-pmenu .kpmbar a.current');if(curr){curr.classList.remove('current');curr.focus();}}});mp.addEventListener('focusout',function(e){let n=e.relatedTarget;if(n&&!n.closest('#menu-panel')){mpi.querySelector('a').focus();}});}
function filterClick(e){var selector=e.target.getAttribute('data-list-selector');if(selector){var filter=e.target.closest('.filter'),section=filter.closest('.section'),active=filter.querySelector('a.active');if(active){active.classList.remove('active');section.classList.remove(active.getAttribute('data-list-selector'));}
e.target.classList.add('active');e.target.blur();section.classList.add(selector);checkAnyStared()
e.preventDefault();e.stopPropagation();}}
function starClick(e){var item=e.target.closest('.kpmstarable'),slug=item.getAttribute("id"),title=item.querySelector('.star-toggle title');if(item.classList.contains('stared')){sendRequest(KthToolbarConfig.socialUrl+"/home/subscriptions/edit/star/?slug="+slug+"&star=false&kthpm=t",{'done':function(){item.classList.remove("stared");title.innerHTML=msg('addfav');checkAnyStared()},'fail':function(){title.innerHTML=msg('noremfav');}});}else{sendRequest(KthToolbarConfig.socialUrl+"/home/subscriptions/edit/star/?slug="+slug+"&star=true&kthpm=t",{'done':function(){item.classList.add("stared");title.innerHTML=msg('remfav');},'fail':function(){title.innerHTML=msg('noaddfav');}});}
return false;}
function checkAnyStared(){var container=document.querySelector('#kth-pmenu div.star-container');if(container.querySelector('li.kpmstarable')){var info=container.querySelector('.emptyset');if(container.classList.contains('stared')&&!container.querySelector('li.kpmstarable.stared')){if(info){info.classList.remove('hide');}else{var l=document.createElement('div');l.className='emptyset';l.appendChild(document.createTextNode(msg('nofav')));container.appendChild(l);}}else{if(info){info.classList.add('hide');}}}}
function menuClick(e){var tl=e.target.closest('a'),pm=document.getElementById('kth-pmenu');if(tl.classList.contains('disable')||pm.classList.contains('busy')){e.preventDefault();e.stopPropagation();return false;}
[].forEach.call(pm.querySelectorAll('.kpmbar .current'),function(elem){if(elem!==tl){elem.classList.remove('current')}});if(tl.classList.contains('current')){hidemenuPanel();tl.classList.remove('current')}else{tl.classList.add('current');pm.classList.add('kpmopen');if(tl.classList.contains('notifications')){document.querySelector('#menu-panel').classList.add('notifications');}else{document.querySelector('#menu-panel').classList.remove('notifications');}
var mpi=document.querySelector('#menu-panel .menu-panel-inner');mpi.innerHTML='<div class="wait">…</div>';document.querySelector('#menu-panel').classList.remove('hide');sendRequest(tl.getAttribute('href')+'?kthpm=t',{'done':function(fetchdata){mpi.innerHTML='<a href="#" onclick="return false;" class="initialHiddenFocus">&nbsp;</a>'+fetchdata;[].forEach.call(mpi.querySelectorAll('.star-container .filter a'),function(a){a.addEventListener('click',filterClick)});[].forEach.call(mpi.querySelectorAll('.kpmstarable'),function(e){e.insertAdjacentHTML('afterbegin','<svg class="star-toggle" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 880 880" width="1em" height="1em"><title/><path d="M440 0l120 336h320L618 532l94 348-272-208-272 208 94-348L0 336h320z" fill="currentColor" stroke-width="10" stroke="#7d5c0c"/></svg>');if(e.classList.contains('stared')){e.querySelector('.star-toggle title').innerHTML=msg('remfav');}else{e.querySelector('.star-toggle title').innerHTML=msg('addfav');}
e.querySelector('.star-toggle').addEventListener('click',starClick);});showmenuPanel();var defaultFilter=mpi.querySelector('.star-container .filter a');if(mpi.querySelector('.star-container li.kpmstarable')&&!mpi.querySelector('.star-container li.kpmstarable.stared')){defaultFilter=mpi.querySelector('.star-container .filter a[data-list-selector=all]');}
if(defaultFilter){defaultFilter.click();}
if(tl.classList.contains('notifications')){init_notice_markers(mpi);tl.classList.remove('changed');}},'fail':function(){mpi.innerHTML='<h2>'+msg('err')+'</h2><div class="kpmrow"><div class="kpmcol"><p>'+'<a href="#" onclick="document.location.reload(true);">'+
msg('fetchfailed')+'</a></p></div></div>';showmenuPanel();}});}
e.preventDefault();e.stopPropagation();return false;}
function sendRequest(url,opts){var r=new XMLHttpRequest(),pm=document.getElementById('kth-pmenu');pm.classList.add('busy');r.open(opts.post?'POST':'GET',url);r.withCredentials=true;if(opts.post){r.setRequestHeader("Content-type","application/x-www-form-urlencoded");}
r.onload=function(){if(r.status===200){if(opts.done){opts.done(r.responseText);}}else{if(opts.fail){opts.fail();}}
pm.classList.remove('busy');}
r.onerror=function(){if(opts.fail){opts.fail()}
pm.classList.remove('busy');}
r.ontimeout=function(){if(opts.fail){opts.fail()}
pm.classList.remove('busy');}
r.send(opts.post||null)}
function fetchTopMenu(){function trackClick(e){var link=e.target,gas=false;if(link.tagName==='A'){if(typeof _gas!=="undefined"){gas=_gas;}else if(typeof _gaq!=="undefined"){gas=_gaq;}
if(gas){gas.push(['_trackEvent','kth-personal-menu','click',link.textContent]);}}}
var pm=document.createElement('div');{pm.setAttribute('id','kth-pmenu');pm.setAttribute('class','busy');pm.innerHTML='<div id="kthpm-wrapper"><span class="kthpm-progress"></span></div>';var body=document.querySelector('body');body.classList.add('use-personal-menu');if(body.prepend){body.prepend(pm);}else{body.insertBefore(pm,body.firstChild);}}
function initLogin(){var loginButton=document.getElementById('#loginlogoutbutton'),body=document.querySelector('body'),a=pm.querySelector('#kth-pmenu .kpmlogin');if(a){a.setAttribute('href',KthToolbarConfig.loginUrl);body.classList.add('kpmloginbtnonly')}else{body.classList.remove('kpmloginbtnonly')}
if(loginButton){loginButton.remove();}}
function failMainBar(){pm.innerHTML='<div id="kthpm-wrapper"><div class="kpmbar">'+'<a href="https://www.kth.se/social/accounts/login/?next='+escape(location.href)+'" class="fault">'+
msg('mainfail')+'</a></div></div>';}
sendRequest(KthToolbarConfig.socialUrl+'/home/personal-menu/?kthpm=t',{'done':function(data){if(/kthpm-wrapper/.test(data)){pm.innerHTML=data;pm.classList.remove('busy');pm.addEventListener('click',hidemenuPanel)
var mpi=pm.querySelector('.menu-panel-inner');if(mpi){mpi.addEventListener('click',function(e){e.stopPropagation()});}
[].forEach.call(pm.querySelectorAll('#kth-pmenu .kpmbar a.top-mi'),function(a){a.addEventListener('click',menuClick);});var t=pm.querySelector('#kth-pmenu .kpmbar a[href="'+window.location.href+'"]');if(t){t.classList.add('disable');}
pm.addEventListener('click',trackClick);initLogin();var welcome=pm.querySelector('.first-time-welcome');if(welcome){document.addEventListener('click',function helloGoodbye(){document.removeEventListener('click',helloGoodbye);welcome.classList.add('fadeout');})}
if(typeof SystemAlert!=='undefined'&&KthToolbarConfig.enableSystemAlert==="True"){SystemAlert.init('/social',parseInt(document.getElementById('system-alert').getAttribute('data-refresh-interval')));}}else{failMainBar()}},'fail':failMainBar});}
function init_marker_tooltip(marker){if(marker.classList.contains('isread')){marker.setAttribute('title','Läst. Klicka för att markera som oläst');}else if(marker.classList.contains('isnew')){marker.setAttribute('title','Ny');}else{marker.setAttribute('title','Oläst. Klicka för att markera som läst');}}
function init_notice_markers(container){if(container){[].forEach.call(container.querySelectorAll('.notice-marker'),function(element){init_marker_tooltip(element);element.addEventListener('click',notice_marker_clicked);});}}
function init_manage_notices(){"use strict";var filter_checkbox=document.querySelector('form#notice-filter #notice-unseen');if(filter_checkbox){filter_checkbox.addEventListener('click',function(e){e.target.closest('form').submit();});}
init_notice_markers(document.querySelector('.kthsocial'));}
function decreaseCount(){[].forEach.call(document.querySelectorAll('#kth-pmenu .notices-unread, .kthsocial .notices-unread'),function(e){var count=e.innerHTML;if(count>0){count--;e.innerHTML=count;}});}
function increaseCount(){[].forEach.call(document.querySelectorAll('#kth-pmenu .notices-unread, .kthsocial .notices-unread'),function(e){var count=e.innerHTML;count++;e.innerHTML=count;});}
function notice_marker_clicked(event){var mrkr=event.currentTarget;if(mrkr.classList.contains('isunread')){sendRequest(KthToolbarConfig.socialUrl+'/notifications/mark_notice_read/',{'post':"link="+mrkr.getAttribute('notice-link')+"&time="+mrkr.getAttribute('notice-time')+"&js=auto",'done':function(){mrkr.classList.remove('isunread');mrkr.classList.add('isread');init_marker_tooltip(mrkr);decreaseCount();}});}else if(mrkr.classList.contains('isread')){sendRequest(KthToolbarConfig.socialUrl+'/notifications/mark_notice_unread/',{'post':"link="+mrkr.getAttribute('notice-link')+"&time="+mrkr.getAttribute('notice-time')+"&js=auto",'done':function(){mrkr.classList.remove('isread');mrkr.classList.add('isunread');init_marker_tooltip(mrkr);increaseCount();}});}else{if(mrkr.classList.contains('isnotnew')){increaseCount();}else{decreaseCount();}
sendRequest(KthToolbarConfig.socialUrl+'/notifications/mark_notice_read/',{'post':"link="+mrkr.getAttribute('notice-link')+"&js=auto",'done':function(){mrkr.classList.remove('isnotnew');marker.classList.add('isnew');init_marker_tooltip(mrkr);}});}}
var l=document.createElement('link');l.rel='stylesheet';l.type='text/css';l.href='https://www.kth.se/social/static/css/personal_menu.9d530e3ad434.css';document.head.appendChild(l);fetchTopMenu();init_manage_notices();}
function initKthToolbar0(){if('classList'in document.body&&'closest'in document.body){initKthToolbar();}else{var s=document.createElement('script');s.type='text/javascript';s.src='https://www.kth.se/social/static/js/kthpm-polyfill.js';s.onload=initKthToolbar;document.head.appendChild(s);}}
if(document.location==top.location){if(document.readyState==='loading'){document.addEventListener("DOMContentLoaded",initKthToolbar0);}else{initKthToolbar0();}}