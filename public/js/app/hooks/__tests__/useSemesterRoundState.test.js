const roundsBySemester = {
  20222: [
    {
      round_time_slots: '<i>No information inserted</i>',
      round_start_date: '30 Oct 2022',
      round_end_date: '15 Jan 2023',
      round_target_group: '<i>No information inserted</i>',
      round_tutoring_form: 'NML',
      round_tutoring_time: 'DAG',
      round_tutoring_language: 'Swedish',
      round_course_place: 'KTH Campus',
      round_campus: 'KTH Campus',
      round_short_name: 'CMATD1 m.fl.',
      round_application_code: '52226',
      round_schedule: '<i>No information inserted</i>',
      round_study_pace: 50,
      round_course_term: ['2022', '2'],
      round_periods: 'P2 (7.5 hp)',
      round_seats: '',
      round_selection_criteria: '<p></p>',
      round_type: 'Programutbildning',
      round_funding_type: 'ORD',
      round_application_link: '<i>No information inserted</i>',
      round_part_of_programme:
        '<p>\n          <a href="/student/kurser/program/CSAMH/20232/arskurs1">\n            Degree Programme in Civil Engineering and Urban Management, åk 1, Mandatory\n        </a>\n      </p><p>\n          <a href="/student/kurser/program/CTKEM/20232/arskurs1">\n            Degree Programme in Engineering Chemistry, åk 1, Mandatory\n        </a>\n      </p><p>\n          <a href="/student/kurser/program/CMATD/20232/arskurs1">\n            Degree Programme in Materials Design and Engineering, åk 1, Mandatory\n        </a>\n      </p><p>\n          <a href="/student/kurser/program/CLGYM/20222/arskurs2#inrMAKE">\n            Master of Science in Engineering and in Education, åk 2, MAKE, Mandatory\n        </a>\n      </p><p>\n          <a href="/student/kurser/program/CLGYM/20222/arskurs2#inrTEDA">\n            Master of Science in Engineering and in Education, åk 2, TEDA, Mandatory\n        </a>\n      </p>',
      round_state: 'APPROVED',
      round_comment: '',
      round_category: 'PU',
    },
  ],
  20232: [
    {
      round_time_slots: '<i>No information inserted</i>',
      round_start_date: '30 Oct 2023',
      round_end_date: '15 Jan 2024',
      round_target_group: '<i>No information inserted</i>',
      round_tutoring_form: 'NML',
      round_tutoring_time: 'DAG',
      round_tutoring_language: 'Swedish',
      round_course_place: 'KTH Campus',
      round_campus: 'KTH Campus',
      round_short_name: 'CMATD1 m.fl.',
      round_application_code: '51446',
      round_schedule: '<i>No information inserted</i>',
      round_study_pace: 50,
      round_course_term: ['2023', '2'],
      round_periods: 'P2 (7.5 hp)',
      round_seats: '',
      round_selection_criteria: '<p></p>',
      round_type: 'Programutbildning',
      round_funding_type: 'ORD',
      round_application_link: '<i>No information inserted</i>',
      round_part_of_programme:
        '<p>\n          <a href="/student/kurser/program/CSAMH/20232/arskurs1">\n            Degree Programme in Civil Engineering and Urban Management, åk 1, Mandatory\n        </a>\n      </p><p>\n          <a href="/student/kurser/program/CTKEM/20232/arskurs1">\n            Degree Programme in Engineering Chemistry, åk 1, Mandatory\n        </a>\n      </p><p>\n          <a href="/student/kurser/program/CMATD/20232/arskurs1">\n            Degree Programme in Materials Design and Engineering, åk 1, Mandatory\n        </a>\n      </p><p>\n          <a href="/student/kurser/program/CLGYM/20222/arskurs2#inrMAKE">\n            Master of Science in Engineering and in Education, åk 2, MAKE, Mandatory\n        </a>\n      </p><p>\n          <a href="/student/kurser/program/CLGYM/20222/arskurs2#inrTEDA">\n            Master of Science in Engineering and in Education, åk 2, TEDA, Mandatory\n        </a>\n      </p>',
      round_state: 'APPROVED',
      round_comment: '',
      round_category: 'PU',
    },
    {
      round_time_slots: '<i>No information inserted</i>',
      round_start_date: '30 Oct 2023',
      round_end_date: '15 Jan 2024',
      round_target_group: '<i>No information inserted</i>',
      round_tutoring_form: 'NML',
      round_tutoring_time: 'DAG',
      round_tutoring_language: 'Swedish',
      round_course_place: 'KTH Campus',
      round_campus: 'KTH Campus',
      round_short_name: 'CDATE1',
      round_application_code: '51350',
      round_schedule: '<i>No information inserted</i>',
      round_study_pace: 50,
      round_course_term: ['2023', '2'],
      round_periods: 'P2 (7.5 hp)',
      round_seats: '',
      round_selection_criteria: '<p></p>',
      round_type: 'Programutbildning',
      round_funding_type: 'ORD',
      round_application_link: '<i>No information inserted</i>',
      round_part_of_programme:
        '<p>\n          <a href="/student/kurser/program/CDATE/20232/arskurs1">\n            Degree Programme in Computer Science and Engineering, åk 1, Mandatory\n        </a>\n      </p>',
      round_state: 'APPROVED',
      round_comment: '',
      round_category: 'PU',
    },
  ],
  20242: [
    {
      round_time_slots: '<i>No information inserted</i>',
      round_start_date: '28 Oct 2024',
      round_end_date: '13 Jan 2025',
      round_target_group: '<i>No information inserted</i>',
      round_tutoring_form: 'NML',
      round_tutoring_time: 'DAG',
      round_tutoring_language: 'Swedish',
      round_course_place: 'KTH Campus',
      round_campus: 'KTH Campus',
      round_short_name: 'CMETE1 m.fl.',
      round_application_code: '50233',
      round_schedule: '<i>No information inserted</i>',
      round_study_pace: 50,
      round_course_term: ['2024', '2'],
      round_periods: 'P2 (7.5 hp)',
      round_seats: '',
      round_selection_criteria: '<p></p>',
      round_type: 'Programutbildning',
      round_funding_type: 'ORD',
      round_application_link: '<i>No information inserted</i>',
      round_part_of_programme:
        '<p>\n          <a href="/student/kurser/program/COPEN/20242/arskurs1">\n            Degree Programme Open Entrance, åk 1, Mandatory\n        </a>\n      </p><p>\n          <a href="/student/kurser/program/CMETE/20242/arskurs1">\n            Degree Programme in Media Technology, åk 1, Mandatory\n        </a>\n      </p>',
      round_state: 'APPROVED',
      round_comment: '',
      round_category: 'PU',
    },
    {
      round_time_slots: '<i>No information inserted</i>',
      round_start_date: '28 Oct 2024',
      round_end_date: '13 Jan 2025',
      round_target_group: '<i>No information inserted</i>',
      round_tutoring_form: 'NML',
      round_tutoring_time: 'DAG',
      round_tutoring_language: 'Swedish',
      round_course_place: 'KTH Kista',
      round_campus: 'KTH Kista',
      round_short_name: 'CINTE1',
      round_application_code: '51098',
      round_schedule: '<i>No information inserted</i>',
      round_study_pace: 50,
      round_course_term: ['2024', '2'],
      round_periods: 'P2 (7.5 hp)',
      round_seats: '',
      round_selection_criteria: '<p></p>',
      round_type: 'Programutbildning',
      round_funding_type: 'ORD',
      round_application_link: '<i>No information inserted</i>',
      round_part_of_programme:
        '<p>\n          <a href="/student/kurser/program/CINTE/20242/arskurs1">\n            Degree Programme in Information and Communication Technology, åk 1, Mandatory\n        </a>\n      </p>',
      round_state: 'APPROVED',
      round_comment: '',
      round_category: 'PU',
    },
  ],
}

const syllabusList = [
  {
    course_goals:
      '<p>After the course the student should be able to</p><ul><li>use concepts. theorems and methods to solve and present solutions to problems within the parts of linear algebra described by the course content,</li><li>read and comprehend mathematical text.</li></ul>',
    course_content:
      "<p>Vectors, matrices, linear equations, Gaussian elimination, vector&#160; geometry with dot product and vector product, determinants, vector spaces, linear independence, bases, change of basis, linear transformations, the least-squares method, eigenvalues, eigenvectors, quadratic forms, orthogonality, inner-product space, Gram-Schmidt's method.</p>",
    course_eligibility: '<p>Basic requirements.&#160;</p><p><strong>&#160;</strong></p>',
    course_requirments_for_final_grade: '<p>Written exam, possibly with the possibility of continuous examination.</p>',
    course_literature: '<i>No information inserted</i>',
    course_literature_comment:
      '<p>Announced no later than 4 weeks before the start of the course on the course web page.</p>',
    course_valid_from: {
      year: 2019,
      semesterNumber: 2,
    },
    course_valid_to: [],
    course_required_equipment: '<i>No information inserted</i>',
    course_examination:
      "<ul class='ul-no-padding' ><li>TEN1 - \n                          Examination,\n                          7.5  credits,  \n                          grading scale: A, B, C, D, E, FX, F              \n                          </li></ul>",
    course_examination_comments:
      'Based on recommendation from KTH’s coordinator for disabilities, the examiner will decide how to adapt an examination for students with documented disability. <br><br>The examiner may apply another examination format when re-examining individual students.<p>The examiner decides, in consultation with KTHs Coordinator of students with disabilities (Funka), about any customized examination for students with documented, lasting disability.&#160;</p>',
    course_ethical:
      "<ul><li>All members of a group are responsible for the group's work.</li><li>In any assessment, every student shall honestly disclose any help received and sources used.</li><li>In an oral assessment, every student shall be able to present and answer questions about the entire assignment and solution.</li></ul>",
    course_additional_regulations: '',
    course_transitional_reg: '',
    course_decision_to_discontinue: '<i>No information inserted</i>',
  },
  {
    course_goals:
      '<p>After completing the course students should for a passing grade be able to</p><ul><li>use the basic concepts and problem solving methods in linear&#160;algebra and geometry. In particular it means to be able to:<br />- understand, interpret and use the basic concepts: the vector space&#160;Rn, subspaces of Rn, linear dependence and independence, basis,&#160;dimension, linear transformations, matrix, determinant, eigenvalue and&#160;eigenvector.<br />- solve geometric problems in two and three dimensions using for&#160;example vectors, dot product, vector product, triple product and&#160;projection.<br />- use Gauss-Jordan?s method for example to solve linear systems of&#160;equations, calculate inverse matrices, determinants and to resolve&#160;questions about linearly independent.<br />- use matrix and determinant calculus to address issues regarding&#160;linear transformations and linear systems.<br />- use the least-squares method to solve for example problems with&#160;over-determined linear systems of equations.<br />- use different bases for vector spaces to handle vectors and linear&#160;transformations, and to manage changes of bases and linear coordinate&#160;transformations.<br />- compute eigenvalues and eigenvectors and use this for example in&#160;order to diagonalize matrices, to study quadratic forms, conics in the&#160;plane and quadratic surfaces in three space.<br />- use the Euclidean inner product in order to address the questions&#160;<br />about distance, orthogonality and projection, and apply Gram-Schmidt?s&#160;<br />method to calculate orthogonal bases of subspaces.</li><li>set up simple mathematical models where the fundamental concepts&#160;in linear algebra and geometry are used, discuss the relevance of such&#160;<br />models, reasonableness and accuracy, and know how mathematical&#160; software can be used for calculations and visualization.</li><li>read and understand mathematical texts about for example,&#160; vectors, matrices, linear transformations and their applications,&#160;communicate mathematical reasoning and calculations in this area,&#160;orally and in writing in such a way that they are easy to follow.</li></ul><p>For higher grades, the student in addition should be able to:</p><ul><li>manage general vector spaces, such as function spaces or vector&#160;spaces of matrices. </li><li>use other inner products than the Euclidean inner product.</li><li>derive important relations in linear algebra and geometry.</li><li>generalize and adapt the methods to use in somewhat new contexts.</li><li>solve problems that require synthesis of material and ideas from&#160;all over the course.</li><li>describe the theory behind concepts such as eigenvalues and&#160;orthogonality.</li></ul>',
    course_content:
      '<p>Vectors, matrices, linear equations, Gaussian elimination, vector&#160; geometry with dot product and vector product, determinants, vector&#160;spaces, linear independence, bases, change of basis, the least-squares&#160;method, eigenvalues, eigenvectors, quadratic forms, orthogonality,&#160;inner-product space, Gram-Schmidt?s method</p>',
    course_eligibility:
      '<p>Basic and specific requirements for engineering program.<br /><strong>Mandatory for first year, can not be read by other students</strong></p>',
    course_requirments_for_final_grade: '<p>Written exam, possibly with the possibility of continuous examination.</p>',
    course_literature: '<i>No information inserted</i>',
    course_literature_comment: '<i>No information inserted</i>',
    course_valid_from: {
      year: 2010,
      semesterNumber: 2,
    },
    course_valid_to: {
      year: 2019,
      semesterNumber: 1,
    },
    course_required_equipment: '<i>No information inserted</i>',
    course_examination:
      "<ul class='ul-no-padding' ><li>TEN1 - \n                          Examination,\n                          7.5  credits,  \n                          grading scale: A, B, C, D, E, FX, F              \n                          </li></ul>",
    course_examination_comments:
      'Based on recommendation from KTH’s coordinator for disabilities, the examiner will decide how to adapt an examination for students with documented disability. <br><br>The examiner may apply another examination format when re-examining individual students.',
    course_ethical:
      "<ul><li>All members of a group are responsible for the group's work.</li><li>In any assessment, every student shall honestly disclose any help received and sources used.</li><li>In an oral assessment, every student shall be able to present and answer questions about the entire assignment and solution.</li></ul>",
    course_additional_regulations: '',
    course_transitional_reg: '',
    course_decision_to_discontinue: '<i>No information inserted</i>',
  },
]

const activeSemesters = [
  {
    year: '2023',
    semesterNumber: '2',
    semester: '20232',
  },
  {
    year: '2024',
    semesterNumber: '2',
    semester: '20242',
  },
]

const { renderHook, waitFor, act } = require('@testing-library/react')
const { useSemesterRoundState } = require('../useSemesterRoundState')

describe('useSemesterRoundsLogic', () => {
  test('returns correct values', () => {
    const { result } = renderHook(() =>
      useSemesterRoundState({
        initiallySelectedRoundIndex: undefined,
        initiallySelectedSemester: 20242,
        roundsBySemester,
        syllabusList,
        activeSemesters,
      })
    )

    expect(result.current.selectedRoundIndex).toBe(undefined)
    expect(result.current.activeRound).toEqual({})
    expect(result.current.selectedSemester).toBe(20242)
    expect(result.current.showRoundData).toBe(false)
    expect(result.current.activeSemesterOnlyHasOneRound).toBe(false)
    expect(result.current.firstRoundInActiveSemester).toEqual(roundsBySemester[20242][0])
    expect(result.current.hasActiveSemesters).toBe(true)
    expect(result.current.activeSyllabus).toBe(syllabusList[0])
    expect(result.current.hasSyllabus).toBe(true)
  })

  test('updates selectedRoundIndex, showRoundData and activeRound when setSelectedRoundIndex is called', async () => {
    const { result } = renderHook(() =>
      useSemesterRoundState({
        initiallySelectedRoundIndex: undefined,
        initiallySelectedSemester: 20242,
        roundsBySemester,
        syllabusList,
        activeSemesters,
      })
    )
    expect(result.current.selectedRoundIndex).toBe(undefined)
    expect(result.current.activeRound).toEqual({})
    expect(result.current.showRoundData).toBe(false)

    act(() => {
      result.current.setSelectedRoundIndex(0)
    })

    await waitFor(() => expect(result.current.selectedRoundIndex).toBe(0))
    await waitFor(() => expect(result.current.showRoundData).toBe(true))
    await waitFor(() => expect(result.current.activeRound).toEqual(roundsBySemester[20242][0]))
  })

  test('updates selectedSemester, firstRoundInActiveSemester, when setSelectedSemester is called', async () => {
    const { result } = renderHook(() =>
      useSemesterRoundState({
        initiallySelectedRoundIndex: undefined,
        initiallySelectedSemester: 20242,
        roundsBySemester,
        syllabusList,
        activeSemesters,
      })
    )

    act(() => {
      result.current.setSelectedSemester(20232)
    })

    await waitFor(() => expect(result.current.selectedSemester).toBe(20232))
    await waitFor(() => expect(result.current.firstRoundInActiveSemester).toBe(roundsBySemester[20232][0]))
  })

  test('if selectedRoundIndex is set and setSelectedSemester is called, reset selectedRoundIndex, activeRound and showRoundData', async () => {
    const { result } = renderHook(() =>
      useSemesterRoundState({
        initiallySelectedRoundIndex: undefined,
        initiallySelectedSemester: 20242,
        roundsBySemester,
        syllabusList,
        activeSemesters,
      })
    )
    expect(result.current.selectedRoundIndex).toBe(undefined)
    expect(result.current.showRoundData).toBe(false)
    expect(result.current.activeRound).toEqual({})

    act(() => {
      result.current.setSelectedRoundIndex(0)
    })

    await waitFor(() => expect(result.current.selectedRoundIndex).toBe(0))
    await waitFor(() => expect(result.current.showRoundData).toBe(true))
    await waitFor(() => expect(result.current.activeRound).toEqual(roundsBySemester[20242][0]))

    act(() => {
      result.current.setSelectedSemester(20232)
    })
    await waitFor(() => expect(result.current.selectedRoundIndex).toBe(undefined))
    await waitFor(() => expect(result.current.showRoundData).toBe(false))
    await waitFor(() => expect(result.current.activeRound).toEqual({}))
  })

  test('if a semester with only one round is selected, that round should be selected', async () => {
    const { result } = renderHook(() =>
      useSemesterRoundState({
        initiallySelectedRoundIndex: undefined,
        initiallySelectedSemester: 20222,
        roundsBySemester,
        syllabusList,
        activeSemesters,
      })
    )
    expect(result.current.activeSemesterOnlyHasOneRound).toBe(true)
    expect(result.current.showRoundData).toBe(true)

    expect(result.current.activeRound).toEqual(roundsBySemester[20222][0])
  })

  test('if initiallySelectedSemester is a string, converts it to number', async () => {
    const { result } = renderHook(() =>
      useSemesterRoundState({
        initiallySelectedRoundIndex: undefined,
        initiallySelectedSemester: '20222',
        roundsBySemester,
        syllabusList,
        activeSemesters,
      })
    )

    expect(result.current.selectedSemester).toStrictEqual(20222)
  })

  test.each([[], undefined])(
    'if roundsBySemester is empty or undefined, returns values accordingly',
    async invalidRoundsBySemester => {
      const { result } = renderHook(() =>
        useSemesterRoundState({
          initiallySelectedRoundIndex: undefined,
          initiallySelectedSemester: 20242,
          roundsBySemester: invalidRoundsBySemester,
          syllabusList,
          activeSemesters,
        })
      )

      expect(result.current.activeSemesterOnlyHasOneRound).toBe(false)
      expect(result.current.showRoundData).toBe(false)
      expect(result.current.firstRoundInActiveSemester).toEqual({})

      expect(result.current.selectedRoundIndex).toBe(undefined)
      expect(result.current.activeRound).toEqual({})
    }
  )

  test('picks correct syllabus for selected semester', async () => {
    const { result } = renderHook(() =>
      useSemesterRoundState({
        initiallySelectedRoundIndex: undefined,
        initiallySelectedSemester: 20182,
        roundsBySemester,
        syllabusList,
        activeSemesters,
      })
    )

    expect(result.current.activeSyllabus).toBe(syllabusList[1])
    expect(result.current.hasSyllabus).toBe(true)
  })

  test('if no syllabuses are, sets activeSyllabus to undefined and hasSyllabus to false', async () => {
    const { result } = renderHook(() =>
      useSemesterRoundState({
        initiallySelectedRoundIndex: undefined,
        initiallySelectedSemester: 20182,
        roundsBySemester,
        syllabusList: [],
        activeSemesters,
      })
    )

    expect(result.current.activeSyllabus).toEqual(undefined)
    expect(result.current.hasSyllabus).toBe(false)
  })

  test('if no valid syllabus is given, sets activeSyllabus to undefined and hasSyllabus to false', async () => {
    const { result } = renderHook(() =>
      useSemesterRoundState({
        initiallySelectedRoundIndex: undefined,
        initiallySelectedSemester: 20182,
        roundsBySemester,
        syllabusList: [{ course_valid_from: [], course_valid_to: [] }],
        activeSemesters,
      })
    )

    expect(result.current.activeSyllabus).toEqual(undefined)
    expect(result.current.hasSyllabus).toBe(false)
  })

  test('calling resetSelectedRoundIndex resets round values', async () => {
    const { result } = renderHook(() =>
      useSemesterRoundState({
        initiallySelectedRoundIndex: undefined,
        initiallySelectedSemester: 20242,
        roundsBySemester,
        syllabusList,
        activeSemesters,
      })
    )

    expect(result.current.selectedRoundIndex).toBe(undefined)
    expect(result.current.showRoundData).toBe(false)
    expect(result.current.activeRound).toEqual({})

    act(() => {
      result.current.setSelectedRoundIndex(0)
    })

    await waitFor(() => expect(result.current.selectedRoundIndex).toBe(0))
    await waitFor(() => expect(result.current.showRoundData).toBe(true))
    await waitFor(() => expect(result.current.activeRound).toEqual(roundsBySemester[20242][0]))

    act(() => {
      result.current.resetSelectedRoundIndex()
    })
    await waitFor(() => expect(result.current.selectedRoundIndex).toBe(undefined))
    await waitFor(() => expect(result.current.showRoundData).toBe(false))
    await waitFor(() => expect(result.current.activeRound).toEqual({}))
  })
})
